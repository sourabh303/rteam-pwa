<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>RTeam Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1e56ce">

  <link rel="manifest" href="manifest.json">

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW Registered'))
          .catch(err => console.log('SW Registration Failed', err));
      });
    }

    // Install Prompt Logic
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      const installBtn = document.getElementById('installBtn');
      if (installBtn) installBtn.classList.remove('hidden');
    });
  </script>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <style>
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    html, body { height: 100%; width: 100%; overflow: hidden; font-family: sans-serif; }
    .header { background: #1e56ce; color: white; padding: 1rem 1.2rem; padding-top: max(1rem, env(safe-area-inset-top)); }
    .scanner-wrapper { flex: 1; display: flex; align-items: center; justify-content: center; background: #000; position: relative; }
    #reader { width: 100% !important; height: 100% !important; }
    #reader video { object-fit: cover !important; }
    .toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 2rem; border-radius: 24px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); z-index: 9999; text-align: center; width: 80%; }
  </style>
</head>

<body class="flex flex-col h-full bg-slate-50">
  <audio id="soundSuccess" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3" preload="auto"></audio>
  <audio id="soundError" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" preload="auto"></audio>

  <header class="header flex justify-between items-center shrink-0">
    <div class="flex items-center gap-3">
      <div class="h-9 w-9 bg-white rounded-lg p-1 flex items-center justify-center font-bold text-blue-700">RT</div>
      <div class="text-xl font-black tracking-tight">RTeam Hub</div>
    </div>
    <div id="statusText" class="text-[10px] font-bold bg-white/20 px-3 py-1 rounded-full uppercase">Ready</div>
  </header>

  <main class="scanner-wrapper">
    <div id="reader"></div>
  </main>

  <footer class="p-6 text-center bg-white border-t">
    <button id="installBtn" class="hidden mb-4 bg-blue-600 text-white px-6 py-2 rounded-full font-bold shadow-lg w-full">
      Install App to Home Screen
    </button>
    <div class="font-bold text-slate-800">Attendance Scanner</div>
    <div class="text-xs text-slate-400 mt-1 uppercase tracking-widest">Center QR in frame</div>
  </footer>

  <script>
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzNp7960JWjeDPKH64zH-8ozh07BlxKZdjQVafNfd5A0CXeF_vHCG2o0Zo-ayveuIG5nQ/exec";
    let isScanning = false;

    // Install Button Click Handler
    document.getElementById('installBtn').addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') document.getElementById('installBtn').classList.add('hidden');
        deferredPrompt = null;
      }
    });

    function showToast(icon, title, message, isSuccess) {
      const audio = document.getElementById(isSuccess ? 'soundSuccess' : 'soundError');
      audio.play().catch(() => {});
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<div class="text-6xl mb-4">${icon}</div><div class="text-2xl font-black">${title}</div><div class="text-slate-500 mt-2">${message}</div>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    async function onScanSuccess(decodedText) {
      if (isScanning) return;
      isScanning = true;
      document.getElementById('statusText').textContent = 'Syncing...';

      try {
        const data = JSON.parse(decodedText);
        
        fetch(GAS_URL, {
          method: 'POST',
          mode: 'no-cors', 
          body: JSON.stringify({ workerId: data.id || "Unknown" })
        })
        .then(() => {
          showToast('✅', 'Success', `${data.id || 'User'} Recorded`, true);
          resetScanner();
        })
        .catch(() => {
          showToast('❌', 'Error', 'Connection Failed', false);
          resetScanner();
        });

      } catch (e) {
        showToast('⚠️', 'Invalid QR', 'Not a valid RTeam code', false);
        resetScanner();
      }
    }

    function resetScanner() {
      setTimeout(() => { isScanning = false; document.getElementById('statusText').textContent = 'Ready'; }, 3000);
    }

    // Initialize Scanner
    function initScanner() {
      const scanner = new Html5Qrcode("reader");
      scanner.start({ facingMode: "user" }, { fps: 10, qrbox: 250 }, onScanSuccess)
        .catch(err => console.error("Scanner error:", err));
    }

    window.addEventListener('load', initScanner);
  </script>
</body>
</html>
