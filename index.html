<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>RTeam Hub</title>

<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1e56ce">
<link rel="manifest" href="manifest.json">

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<style>
*{box-sizing:border-box;font-family:system-ui,-apple-system,sans-serif}
body{margin:0;background:#f8fafc;height:100dvh;display:flex;flex-direction:column;overflow:hidden}

/* HEADER */
.header{
  background:#1e56ce;color:white;
  padding:max(1rem,env(safe-area-inset-top)) 1.2rem 1rem;
  display:flex;justify-content:space-between;align-items:center
}
.brand{display:flex;gap:.75rem;font-weight:900;font-size:1.25rem}
.logo{
  width:2.25rem;height:2.25rem;background:white;color:#1e56ce;
  border-radius:.5rem;display:flex;align-items:center;justify-content:center
}

/* STATUS */
.status-badge{
  font-size:10px;font-weight:700;padding:.25rem .75rem;border-radius:9999px
}
.status-ready{background:#22c55e;color:white}
.status-syncing{background:#eab308;color:white}

/* SCANNER */
.scanner-wrapper{
  flex:1;background:black;display:flex;align-items:center;justify-content:center
}

/* TRUE MIRROR */
#reader{width:100%!important;height:100%!important;transform:scaleX(-1)}
#reader video{
  transform:none!important;width:100%!important;height:100%!important;
  object-fit:cover!important
}

/* FOOTER */
footer{
  background:white;padding:1.25rem 1.5rem calc(1rem + env(safe-area-inset-bottom));
  text-align:center;border-top:1px solid #e2e8f0
}

/* INSTALL BUTTON */
.install-btn{
  width:100%;
  padding:.85rem;
  background:#2563eb;
  color:white;
  border:none;
  border-radius:14px;
  font-weight:800;
  margin-bottom:.75rem;
  display:none;
}

/* Hide install button inside PWA */
@media (display-mode: standalone){
  .install-btn{display:none!important}
}

/* TOAST */
.toast{
  position:fixed;top:50%;left:50%;
  transform:translate(-50%,-50%);
  background:white;padding:2rem;border-radius:24px;
  box-shadow:0 20px 50px rgba(0,0,0,.3);
  z-index:9999;text-align:center;width:80%
}
</style>
</head>

<body>

<audio id="soundSuccess" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
<audio id="soundError" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

<header class="header">
  <div class="brand"><div class="logo">RT</div>RTeam Hub</div>
  <div id="statusText" class="status-badge status-ready">Ready</div>
</header>

<main class="scanner-wrapper">
  <div id="reader"></div>
</main>

<footer>
  <button id="installBtn" class="install-btn">Install App</button>
  <h3>Attendance Scanner</h3>
  <p style="font-size:.75rem;color:#94a3b8">Center QR in frame</p>
</footer>

<script>
const GAS_URL = "PASTE_YOUR_GAS_WEBAPP_URL_HERE";
let isScanning = false;
let deferredPrompt;

/* DEVICE UUID */
function getUUID(){
  let id = localStorage.getItem("device_uuid");
  if(!id){
    id = crypto.randomUUID();
    localStorage.setItem("device_uuid", id);
  }
  return id;
}

/* INSTALL BUTTON LOGIC */
const installBtn = document.getElementById("installBtn");

window.addEventListener("beforeinstallprompt", (e)=>{
  if (window.matchMedia("(display-mode: standalone)").matches) return;
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = "block";
});

installBtn.addEventListener("click", async ()=>{
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  installBtn.style.display = "none";
});

/* UI */
function setStatus(state){
  const el=document.getElementById("statusText");
  el.textContent = state==="syncing" ? "Syncing" : "Ready";
  el.className = "status-badge " + (state==="syncing"?"status-syncing":"status-ready");
}

function toast(icon,title,msg,ok){
  document.getElementById(ok?"soundSuccess":"soundError").play().catch(()=>{});
  const t=document.createElement("div");
  t.className="toast";
  t.innerHTML=`<div style="font-size:3rem">${icon}</div><b>${title}</b><div>${msg}</div>`;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

/* SCAN */
async function onScanSuccess(txt){
  if(isScanning) return;
  isScanning = true;
  setStatus("syncing");

  try{
    const d = JSON.parse(txt);
    fetch(GAS_URL,{
      method:"POST",
      mode:"no-cors",
      body:JSON.stringify({
        workerId: d.id,
        workerName: d.name || "",
        department: d.dept || "",
        deviceUUID: getUUID()
      })
    });
    toast("✅","Recorded",d.id,true);
  }catch{
    toast("⚠️","Invalid QR","Wrong format",false);
  }

  setTimeout(()=>{
    isScanning=false;
    setStatus("ready");
  },3000);
}

/* START SCANNER */
window.onload=()=>{
  new Html5Qrcode("reader")
    .start(
      {facingMode:"user"},
      {fps:15,qrbox:250},
      onScanSuccess
    )
    .catch(console.error);
};
</script>

</body>
</html>
